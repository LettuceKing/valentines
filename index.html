<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ú–æ–µ–π –ª—é–±–∏–º–∫–µ ‚ù§Ô∏è</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Marck+Script&family=Nunito:wght@400;700&display=swap');

        * { box-sizing: border-box; }
    
        body {
            margin: 0;
            overflow: hidden;
            /* –ù–µ–∂–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç: –†–∞—Å—Å–≤–µ—Ç */
            background: linear-gradient(to bottom, #fff1eb 0%, #ace0f9 100%);
            font-family: 'Nunito', sans-serif;
            touch-action: none; 
        }

        /* –û–±–ª–∞–∫–∞ –Ω–∞ —Ñ–æ–Ω–µ */
        .cloud {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            opacity: 0.6;
            animation: floatCloud linear infinite;
            z-index: 0;
        }

        @keyframes floatCloud {
            from { transform: translateX(-200px); }
            to { transform: translateX(110vw); }
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            pointer-events: none;
        }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è */
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            z-index: 10;
            display: flex;
            justify-content: center;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        #progress-container {
            width: 300px;
            height: 25px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            border: 3px solid #ff9a9e;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff9a9e, #fad0c4);
            transition: width 0.4s ease-out;
        }

        #progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 20px;
            font-size: 14px;
            color: #d6336c;
            font-weight: bold;
            top: 0;
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            /* –£–±–∏—Ä–∞–µ–º –∂–µ—Å—Ç–∫–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ —É–ª–µ—Ç–∞–ª –≤–≤–µ—Ä—Ö */
            justify-content: flex-start; 
            align-items: center;
            z-index: 20;
            transition: opacity 0.8s, visibility 0.8s;
            padding: 40px 20px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É */
            text-align: center;
            overflow-y: auto; /* –ü–æ–∑–≤–æ–ª—è–µ—Ç –ª–∏—Å—Ç–∞—Ç—å, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª–∏–Ω–Ω—ã–π */
        }

        .hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        h1 {
            font-family: 'Marck Script', cursive;
            font-size: 3.2rem;
            color: #d6336c;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        p {
            font-size: 1.2rem;
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
            max-width: 550px;
        }

        .btn {
            background: #ff9a9e;
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4);
            transition: transform 0.2s, background 0.2s;
            font-family: 'Nunito', sans-serif;
            font-weight: bold;
        }

        .btn:active {
            transform: scale(0.95);
        }
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –£—Ä–æ–≤–Ω—è 2 (–ö–ª–∏–∫ –ø–æ —Å–µ—Ä–¥—Ü—É) --- */
        #heart-btn {
            font-size: 8rem;
            padding: 40px;
            background: none;
            border: none;
            cursor: pointer;
            animation: heartbeat 1.5s infinite;
            transition: transform 0.1s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            text-shadow: 0 0 30px rgba(255, 0, 0, 0.3);
            touch-action: manipulation; 
        }

        #heart-btn:active {
            transform: scale(0.9) !important;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –£—Ä–æ–≤–Ω—è 3 (–ü–∞–∑–ª) --- */
        #puzzle-container {
            /* –î–µ–ª–∞–µ–º —Ä–∞–∑–º–µ—Ä –≥–∏–±–∫–∏–º: 90% –æ—Ç —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ 350px */
            width: 90vw;
            height: 90vw;
            max-width: 350px;
            max-height: 350px;
            
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            
            gap: 0; 
            
            border: 5px solid #ff9a9e;
            background: #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            
            touch-action: manipulation; 
        }

        .puzzle-piece {
            /* –†–∞–∑–º–µ—Ä —Ñ–æ–Ω–∞ 300% (—Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å 3 –∫—É—Å–æ—á–∫–∞ –≤ —à–∏—Ä–∏–Ω—É) */
            background-size: 300% 300%;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.5);
        }

        .puzzle-piece.selected {
            transform: scale(0.95);
            box-shadow: 0 0 15px #d6336c;
            z-index: 10;
            border: 2px solid #d6336c;
        }

        /* --- –≠–∫—Ä–∞–Ω –≤–æ–ø—Ä–æ—Å–∞ (–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞) --- */
        #question-screen {
            background: rgba(255, 240, 245, 0.96);
        }

        /* –°—Ç–∏–ª—å –¥–ª—è —Ñ–æ—Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤–æ–ø—Ä–æ—Å–∞ */
        .question-photo {
            width: 80%;
            max-width: 300px;
            border-radius: 15px;
            border: 6px solid #fff;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            margin: 15px 0;
            transform: rotate(-2deg); /* –ù–µ–±–æ–ª—å—à–æ–π –Ω–∞–∫–ª–æ–Ω –¥–ª—è –º–∏–ª–æ—Ç—ã */
            transition: transform 0.3s;
        }
        
        .question-photo:hover {
            transform: rotate(0deg) scale(1.02);
        }

        .btn-group {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        #no-btn {
            background: #aab;
            font-size: 1rem;
            padding: 15px 30px;
        }

        #yes-btn {
            background: #ff758c;
            font-size: 1.4rem;
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* --- –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ --- */
        #win-screen {
            background: rgba(0, 0, 0, 0.4); 
        }

        .letter-card {
            background: #fff;
            
            width: 90%;           
            max-width: 550px;     
            
            max-height: 90vh;  
            overflow-y: auto;     
            margin: auto;        
            
            padding: 15px;        
            border-radius: 15px;  

            border: 4px dashed #ff9a9e; 
            
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            
            transform: translateY(20px);
            opacity: 0;
            transition: all 1s ease 0.5s;
            position: relative;
            z-index: 30;
        }
        
        .letter-card.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* –ß–∞—Å—Ç–∏—Ü—ã —Ç—É–º–∞–Ω–∞ */
        .mist-particle {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, rgba(255, 0, 50, 0.8) 0%, rgba(255, 0, 0, 0) 70%);
            border-radius: 50%;
            filter: blur(15px); 
            pointer-events: none;
            z-index: 40; 
            transform: translate(-50%, -50%);
            animation: mistFloat 1s ease-out forwards;
        }

        @keyframes mistFloat {
            0% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(0.5);
            }
            100% {
                opacity: 0;
                transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(2.5);
            }
        }

        .fade-out-game {
            opacity: 0;
            transition: opacity 1.5s ease-in-out; 
            pointer-events: none; 
        }

        .fade-in-level {
            animation: fadeInLevel 1.5s forwards;
        }

        @keyframes fadeInLevel {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 600px) {
            #question-screen h2 {
                font-size: 1.8rem !important; /* –£–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö */
            }
            h1 {
                font-size: 2.5rem !important;
            }
        }
    </style>
</head>
<body>

<!-- –î–µ–∫–æ—Ä: –æ–±–ª–∞–∫–∞ -->
<div id="clouds"></div>

<!-- UI –£—Ä–æ–≤–Ω—è 1 -->
<div id="ui-layer">
    <div id="progress-container">
        <div id="progress-fill"></div>
        <div id="progress-text">–°–æ–±–∏—Ä–∞–µ–º –ª—é–±–æ–≤—å... 0%</div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
<div id="start-screen" class="overlay">
    <h1>–ö—Ä–∏—Å—Ç–∏–Ω—á–∏–∫...</h1>
    <p>–Ø —Å–¥–µ–ª–∞–ª —ç—Ç—É –∏–≥—Ä—É-–æ—Ç–∫—Ä—ã—Ç–∫—É, —á—Ç–æ–±—ã —Ç—ã —É–ª—ã–±–Ω—É–ª–∞—Å—å.<br>
    –°–ø–µ—Ä–≤–∞ –ø–æ–π–º–∞–π –≤—Å–µ –º–∏–ª–∞—à–Ω–æ—Å—Ç–∏ –∫–æ—Ä–∑–∏–Ω–∫–æ–π, –Ω–µ —Ç–µ—Ä—è–π –∏—Ö!<br>
    –ì–æ—Ç–æ–≤–∞?</p>
    <button class="btn" onclick="startLevel1()">–ù–∞—á–∞—Ç—å ‚ú®</button>
</div>

<!-- –£—Ä–æ–≤–µ–Ω—å 2: –¢–∞–ø–∞–ª–∫–∞ -->
<div id="level-2-screen" class="overlay hidden">
    <h1>–ü–æ—á—Ç–∏-–ø–æ—á—Ç–∏!</h1>
    <p>–ú–æ—ë —Å–µ—Ä–¥—Ü–µ –±—å–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è.<br>–ñ–º—è–∫–∞–π –Ω–∞ –Ω–µ–≥–æ, —á—Ç–æ–±—ã –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –ª—é–±–æ–≤—å—é!</p>
    <button id="heart-btn" onpointerdown="clickHeart(event)">‚ù§Ô∏è</button>
    <p id="click-counter" style="margin-top: 10px; font-weight: bold; color: #ff758c;">0 / 50</p>
</div>

<!-- –£—Ä–æ–≤–µ–Ω—å 3: –ü–∞–∑–ª -->
<div id="level-3-screen" class="overlay hidden">
    <h1>–°–æ–±–µ—Ä–∏ –Ω–∞—Å ‚ù§Ô∏è</h1>
    <p>–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—é—Ä–ø—Ä–∏–∑, –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É.<br>–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫—É—Å–æ—á–∫–∏, —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å –∏—Ö –º–µ—Å—Ç–∞–º–∏!</p>
    <div id="puzzle-container"></div>
    <p id="puzzle-message" style="opacity: 0; color: #d6336c; font-weight: bold;">–û—Ç–ª–∏—á–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è!</p>
</div>

<!-- –≠–∫—Ä–∞–Ω –í–æ–ø—Ä–æ—Å–∞ -->
<div id="question-screen" class="overlay hidden">
    <!-- –û–±–µ—Ä—Ç–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–º–æ–∂–µ—Ç —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –≤–ª–µ–∑–∞–µ—Ç, –∏ –Ω–µ –æ–±—Ä–µ–∑–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç -->
    <div style="margin: auto 0; width: 100%; display: flex; flex-direction: column; align-items: center;">
        
        <h2 style="color: #d6336c; font-family: 'Marck Script'; margin: 10px 0;">–°–º–æ—Ç—Ä–∏, –∫–∞–∫ –º—ã –∏–¥–µ–∞–ª—å–Ω–æ –¥–æ–ø–æ–ª–Ω—è–µ–º –¥—Ä—É–≥ –¥—Ä—É–≥–∞ ‚òØ</h2>
        
        <img id="final-photo" src="" alt="–ú—ã" class="question-photo">

        <h2 style="color: #d6336c; font-family: 'Marck Script'; margin: 10px 0;">–¢—ã –±—É–¥–µ—à—å –º–æ–µ–π –í–∞–ª–µ–Ω—Ç–∏–Ω–∫–æ–π? üåπ</h2>
        
        <div class="btn-group">
            <button id="yes-btn" class="btn" onclick="onYesClicked()">–ö–æ–Ω–µ—á–Ω–æ! –î–ê! ‚ù§Ô∏è</button>
            <button id="no-btn" class="btn" onclick="onNoClicked(event)">–ù–µ—Ç...</button>
        </div>
        
    </div>
</div>

<!-- –≠–∫—Ä–∞–Ω –ø–æ–±–µ–¥—ã -->
<div id="win-screen" class="overlay hidden">
    <div class="letter-card" id="final-letter">
        <h1 style="font-size: 2.2rem;">–£—Ä–∞! –¢—ã —Å–æ–≥–ª–∞—Å–∏–ª–∞—Å—å! üéÜ</h1>
        <p style="font-size: 1.3rem; color: #333;">
            –¢—ã —Å–æ–±—Ä–∞–ª–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∏–∫–∏, –∑–∞–≤–µ–ª–∞ –º–æ—ë —Å–µ—Ä–¥—Ü–µ –∏ —Å–æ–±—Ä–∞–ª–∞ –Ω–∞—à—É –∏—Å—Ç–æ—Ä–∏—é.<br><br>
            –≠—Ç–æ—Ç —Å–∞–ª—é—Ç –≤ —Ç–≤–æ—é —á–µ—Å—Ç—å, —Å–æ–ª–Ω—ã—à–∫–æ.<br>
            <b>–° –¥–Ω—ë–º –≤—Å–µ—Ö –≤–ª—é–±–ª–µ–Ω–Ω—ã—Ö!</b>
        </p>
        <p style="font-size: 3rem;">üå∑üë©‚Äç‚ù§Ô∏è‚Äçüë®üå∑</p>
    </div>
</div>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    const CONFIG = {
        playerEmoji: "üß∫", 
        items: ["‚ù§Ô∏è", "üíñ", "üíû", "üíå", "üå∏", "üß∏", "üç´"], 
        speed: 3.5, 
        targetScore: 33, 
        clicksNeeded: 50, 
        spawnRate: 40,
        puzzleImage: "our_photo.jpg" 
    };

    const compliments = ["–õ—é–±–ª—é —Ç–≤–æ—é —É–ª—ã–±–∫—É!", "–ú–æ—ë —Å–æ–ª–Ω—ã—à–∫–æ!", "–ú–æ–π –∞–Ω–≥–µ–ª–æ—á–µ–∫!", "–õ—é–±–∏–º–∫–∞!", "–û–±–æ–∂–∞—é —Ç–µ–±—è!", "–ü–æ—Ü–µ–ª—É–π—á–∏–∫!", "–í —â—ë—á–∫—É!", "–ü—Ä–æ—Å—Ç–æ –≤–∞—É!", "–û—á–∞—Ä–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Ç—ã!", "–õ—é–±–ª—é —Ç–µ–±—è —Å–ª—É—à–∞—Ç—å!"];
    const clickPhrases = ["–ï—â—ë!", "–°–∏–ª—å–Ω–µ–µ!", "–ñ–º—è–∫-–∂–º—è–∫!", "‚ù§Ô∏è", "–ú—É—Ä!"];
    const sadPhrases = ["–û–π...", "–£–ø–∞–ª–æ üò¢", "–õ–æ–≤–∏!", "–ú–∏–º–æ...", "üíî"];
    
    // –§—Ä–∞–∑—ã –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ù–ï–¢
    const noPhrases = [
        "–≠—ç—ç... –Ω–µ —Ç—É–¥–∞ –Ω–∞–∂–∞–ª–∞ üò≥", 
        "–ö–Ω–æ–ø–∫–∞ —Å–ª–æ–º–∞–ª–∞—Å—å? –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ üëâüëà", 
        "–ù—É –∑–∞—è... —Ç—ã —É–≤–µ—Ä–µ–Ω–∞? ü•∫", 
        "–ê–π-–∞–π, –º–æ—ë —Å–µ—Ä–¥—Ü–µ —Ç—Ä–µ—Å–∫–∞–µ—Ç—Å—è üíî",
        "–ú–µ–Ω—è —â–∞—Å –∫–æ–Ω–¥—Ä–∞—Ç–∏–π —Ö–≤–∞—Ç–∏—Ç... —ç—Ç–æ —á—Ç–æ —Ç–µ–±–µ –¥–æ—Ä–∞–º–∞?!",
        "–°–º–æ—Ç—Ä–∏, –∫–∞–∫–∞—è –∫—Ä–∞—Å–∏–≤–∞—è –∫–Ω–æ–ø–∫–∞ —Ä—è–¥–æ–º ‚ú®",
        "–Å–ª–∫–∏-–∏–≥–æ–ª–∫–∏! –°—É–¥—å–±–∞ —è–≤–Ω–æ –∑–∞ –î–ê!",
        "–õ–∞–¥–Ω–æ... —è –ø–æ–¥–æ–∂–¥—É. –ì–ª–∞–≤–Ω–∞—è –≥–µ—Ä–æ–∏–Ω—è –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–∫–∞–∂–µ—Ç –î–ê üòâ"
    ];

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø CANVAS ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´ ---
    let gameState = 'start'; 
    let items = [];
    let floatingTexts = [];
    let fireworks = []; 
    let score = 0;
    let clickScore = 0;
    let playerX = width / 2;
    let noClickCount = 0;

    // --- –û–ë–õ–ê–ö–ê ---
    function createClouds() {
        const container = document.getElementById('clouds');
        for(let i=0; i<5; i++) {
            let cloud = document.createElement('div');
            cloud.classList.add('cloud');
            let w = 100 + Math.random() * 200;
            cloud.style.width = w + 'px';
            cloud.style.height = (w * 0.6) + 'px';
            cloud.style.top = (Math.random() * height * 0.5) + 'px';
            cloud.style.animationDuration = (20 + Math.random() * 40) + 's';
            cloud.style.left = Math.random() * 100 + 'vw';
            container.appendChild(cloud);
        }
    }
    createClouds();

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï (–£—Ä–æ–≤–µ–Ω—å 1) ---
    function onMove(e) {
        if (gameState !== 'level1') return;
        const x = e.touches ? e.touches[0].clientX : e.clientX;
        playerX = x;
    }
    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove', onMove);

    // --- –ö–õ–ê–°–°–´ CANVAS ---
    class Item {
        constructor() {
            this.x = Math.random() * (width - 40) + 20;
            this.y = -50;
            this.emoji = CONFIG.items[Math.floor(Math.random() * CONFIG.items.length)];
            this.speed = Math.random() * 1.5 + 2;
            this.swingOffset = Math.random() * Math.PI * 2;
        }
        update() {
            this.y += this.speed;
            this.x += Math.sin(this.y * 0.02 + this.swingOffset) * 1; 
        }
        draw() {
            ctx.font = "28px Arial";
            ctx.textAlign = "center";
            ctx.fillText(this.emoji, this.x, this.y);
        }
    }

    class FloatingText {
        constructor(x, y, text, color = "#d6336c") {
            this.x = x;
            this.y = y;
            this.text = text;
            this.color = color;
            this.life = 1.0;
            this.dy = -1.5; 
        }

        update() {
            this.y += this.dy;
            this.life -= 0.010; // –ß—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ –∏—Å—á–µ–∑–∞–µ—Ç, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å
        }

        draw() {
            ctx.save();
            ctx.globalAlpha = Math.max(0, this.life);
            
            // 1. –°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–µ–º —à—Ä–∏—Ñ—Ç (–í–ê–ñ–ù–û –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏–π)
            const fontSize = width < 500 ? 20 : 24; 
            ctx.font = `bold ${fontSize}px Nunito`;
            const lineHeight = fontSize * 1.2;

            // 2. –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ (Word Wrap)
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ 80% –æ—Ç —ç–∫—Ä–∞–Ω–∞
            const maxTextWidth = width * 0.8; 
            const words = this.text.split(' ');
            let lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxTextWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);

            // 3. –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
            let maxWidthInBlock = 0;
            lines.forEach(line => {
                const w = ctx.measureText(line).width;
                if (w > maxWidthInBlock) maxWidthInBlock = w;
            });

            // 4. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º X (–°–¥–≤–∏–≥–∞–µ–º –±–ª–æ–∫, –µ—Å–ª–∏ –æ–Ω —É –∫—Ä–∞—è)
            let drawX = this.x;
            const halfWidth = maxWidthInBlock / 2;
            const padding = 20; // –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞

            // –ï—Å–ª–∏ –ª–µ–≤—ã–π –∫—Ä–∞–π —Ç–µ–∫—Å—Ç–∞ –≤—ã–ª–µ–∑–∞–µ—Ç –≤–ª–µ–≤–æ (< 0)
            if (drawX - halfWidth < padding) {
                drawX = padding + halfWidth;
            }
            // –ï—Å–ª–∏ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π —Ç–µ–∫—Å—Ç–∞ –≤—ã–ª–µ–∑–∞–µ—Ç –≤–ø—Ä–∞–≤–æ (> width)
            else if (drawX + halfWidth > width - padding) {
                drawX = width - padding - halfWidth;
            }

            // 5. –†–∏—Å—É–µ–º
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = this.color;
            ctx.strokeStyle = "white"; 
            ctx.lineWidth = 4;

            lines.forEach((line, i) => {
                // –°–¥–≤–∏–≥–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –≤–Ω–∏–∑
                const lineY = this.y + (i * lineHeight);
                
                ctx.strokeText(line, drawX, lineY);
                ctx.fillText(line, drawX, lineY);
            });

            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            const angle = Math.random() * Math.PI * 2;
            const velocity = Math.random() * 4 + 2;
            this.vx = Math.cos(angle) * velocity;
            this.vy = Math.sin(angle) * velocity;
            this.life = 1.0;
            this.gravity = 0.05;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += this.gravity; 
            this.vx *= 0.95; 
            this.vy *= 0.95;
            this.life -= 0.01;
        }
        draw() {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    function createFirework() {
        const x = Math.random() * width;
        const y = Math.random() * (height / 2); 
        const colors = ['#ff9a9e', '#fad0c4', '#ffecd2', '#fcb69f', '#ff758c', '#ffffff'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        for (let i = 0; i < 30; i++) { 
            fireworks.push(new Particle(x, y, color));
        }
    }

    function createMistEffect(x, y) {
        const particleCount = 6; 
        for (let i = 0; i < particleCount; i++) {
            const mist = document.createElement('div');
            mist.classList.add('mist-particle');
            mist.style.left = x + 'px';
            mist.style.top = y + 'px';
            
            const angle = Math.random() * Math.PI * 2;
            const velocity = 35 + Math.random() * 100;
            const tx = Math.cos(angle) * velocity + 'px';
            const ty = Math.sin(angle) * velocity + 'px';
            mist.style.setProperty('--tx', tx);
            mist.style.setProperty('--ty', ty);
            document.body.appendChild(mist);
            setTimeout(() => mist.remove(), 800);
        }
    }

    function updateProgressUI() {
        let percent = Math.max(0, Math.min((score / CONFIG.targetScore) * 100, 100));
        document.getElementById('progress-fill').style.width = percent + "%";
        document.getElementById('progress-text').innerText = `–°–æ–±—Ä–∞–Ω–æ –ª—é–±–≤–∏: ${Math.floor(percent)}%`;
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---

    function startLevel1() {
        document.getElementById('start-screen').classList.add('hidden');
        gameState = 'level1';
        loop();
    }

    function startLevel2() {
        gameState = 'transition'; 
        const successText = new FloatingText(width/2, height/2, "–¢—ã —É–º–Ω–∏—Ü–∞! ‚ù§Ô∏è", "#ff0055");
        successText.life = 2.0; 
        floatingTexts.push(successText);

        document.getElementById('gameCanvas').classList.add('fade-out-game');
        document.getElementById('ui-layer').classList.add('fade-out-game');

        setTimeout(() => {
            gameState = 'level2';
            const c = document.getElementById('gameCanvas');
            c.style.display = 'block'; 
            c.classList.remove('fade-out-game'); 
            c.style.zIndex = "50";

            const level2 = document.getElementById('level-2-screen');
            level2.classList.remove('hidden');
            level2.classList.add('fade-in-level');
        }, 1000);
    }

    function clickHeart(e) {
        if (gameState !== 'level2') return;
        
        let x, y;
        if (e && e.clientX) {
            x = e.clientX; y = e.clientY;
        } else if (e && e.touches && e.touches[0]) {
            x = e.touches[0].clientX; y = e.touches[0].clientY;
        } else {
            const rect = document.getElementById('heart-btn').getBoundingClientRect();
            x = rect.left + rect.width / 2;
            y = rect.top + rect.height / 2 - 40; 
        }

        clickScore++;
        document.getElementById('click-counter').innerText = `${clickScore} / ${CONFIG.clicksNeeded}`;
        
        if (Math.random() < 0.75) createMistEffect(x, y);
        if (clickScore >= CONFIG.clicksNeeded / 2) {
            const phrase = clickPhrases[Math.floor(Math.random() * clickPhrases.length)];
            floatingTexts.push(new FloatingText(x + (Math.random()*60-30), y - 50, phrase));
        }

        if (clickScore >= CONFIG.clicksNeeded) {
            startLevel3Puzzle();
        }
    }

    // --- –£–†–û–í–ï–ù–¨ 3: –ü–ê–ó–õ ---
    
    let puzzleOrder = [0, 1, 2, 3, 4, 5, 6, 7, 8];
    let selectedPieceIndex = -1;

    function startLevel3Puzzle() {
        gameState = 'puzzle';
        // –°–∫—Ä—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å 2
        document.getElementById('level-2-screen').classList.add('hidden');
        document.getElementById('level-2-screen').classList.remove('fade-in-level');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å 3
        const level3 = document.getElementById('level-3-screen');
        level3.classList.remove('hidden');
        level3.classList.add('fade-in-level');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–∑–ª
        initPuzzle();
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        if (isSorted(array)) {
            [array[0], array[1]] = [array[1], array[0]];
        }
    }

    function isSorted(arr) {
        for(let i = 0; i < arr.length; i++) {
            if(arr[i] !== i) return false;
        }
        return true;
    }

    function initPuzzle() {
        shuffleArray(puzzleOrder);
        renderPuzzle();
    }

    function renderPuzzle() {
        const container = document.getElementById('puzzle-container');
        container.innerHTML = '';
        
        puzzleOrder.forEach((pos, index) => {
            const piece = document.createElement('div');
            piece.classList.add('puzzle-piece');
            piece.style.backgroundImage = `url('${CONFIG.puzzleImage}')`;
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä—è–¥ –∏ –∫–æ–ª–æ–Ω–∫—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∫—É—Å–æ—á–∫–∞
            const row = Math.floor(pos / 3);
            const col = pos % 3;
            
            const x = col * 50; 
            const y = row * 50;
            
            piece.style.backgroundPosition = `${x}% ${y}%`;

            if (index === selectedPieceIndex) {
                piece.classList.add('selected');
            }

            piece.onclick = () => onPieceClick(index);
            container.appendChild(piece);
        });
    }

    function onPieceClick(index) {
        if (selectedPieceIndex === -1) {
            selectedPieceIndex = index;
            renderPuzzle();
        } else {
            [puzzleOrder[selectedPieceIndex], puzzleOrder[index]] = [puzzleOrder[index], puzzleOrder[selectedPieceIndex]];
            selectedPieceIndex = -1;
            renderPuzzle();
            checkPuzzleWin();
        }
    }

    function checkPuzzleWin() {
        if (isSorted(puzzleOrder)) {
            document.getElementById('puzzle-message').style.opacity = '1';
            document.getElementById('puzzle-message').innerText = "–ö—Ä–∞—Å–æ—Ç–∞! ‚ù§Ô∏è";
            setTimeout(showQuestionScreen, 1500);
        }
    }

    // --- –≠–ö–†–ê–ù –í–û–ü–†–û–°–ê ---

    function showQuestionScreen() {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ –≤ img —Ç–µ–≥
        document.getElementById('final-photo').src = CONFIG.puzzleImage;

        document.getElementById('level-3-screen').classList.add('hidden');
        document.getElementById('question-screen').classList.remove('hidden');
        document.getElementById('question-screen').classList.add('fade-in-level');
    }

    let yesScale = 1;

    function onNoClicked(e) {
        if (noClickCount >= noPhrases.length) {
            document.getElementById('no-btn').style.display = 'none';
            return;
        }

        // 2. –í—ã–±–∏—Ä–∞–µ–º —Ñ—Ä–∞–∑—É (—Ç–µ–ø–µ—Ä—å –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è %, –ø—Ä–æ—Å—Ç–æ –ø–æ –ø–æ—Ä—è–¥–∫—É)
        const text = noPhrases[noClickCount];
        noClickCount++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
        
        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–∞
        let x = e.clientX;
        let y = e.clientY;

        const margin = 80;
        if (x < margin) x = margin;
        if (x > width - margin) x = width - margin;
        x += (Math.random() * 20 - 10);
        
        // –°–æ–∑–¥–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—à–∫—É
        const ft = new FloatingText(x, y - 40, text, "#2c3e50");
        ft.fontSize = 20;
        ft.life = 2.5; // –°–¥–µ–ª–∞–ª–∏ –∂–∏–∑–Ω—å –ø–æ–¥–ª–∏–Ω–Ω–µ–µ, –∫–∞–∫ –æ–±—Å—É–∂–¥–∞–ª–∏ —Ä–∞–Ω–µ–µ
        floatingTexts.push(ft);

        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –î–ê
        yesScale += 0.09;
        document.getElementById('yes-btn').style.transform = `scale(${yesScale})`;

        // 3. –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ñ—Ä–∞–∑–∞ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–µ—Ç"
        if (noClickCount === noPhrases.length) {
            // –î–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ–ª –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ñ—Ä–∞–∑—É
            setTimeout(() => {
                const noBtn = document.getElementById('no-btn');
                noBtn.style.transition = "opacity 0.5s, transform 0.5s";
                noBtn.style.opacity = "0";
                noBtn.style.transform = "scale(0)";
                setTimeout(() => {
                    noBtn.style.display = 'none';
                }, 500);
            }, 1000); 
        }
    }

    function onYesClicked() {
        document.getElementById('question-screen').classList.add('hidden');
        startWin();
    }

    // --- –§–ò–ù–ê–õ ---
    function startWin() {
        gameState = 'win';
        
        document.getElementById('win-screen').classList.remove('hidden');

        const c = document.getElementById('gameCanvas');
        c.style.display = 'block';   
        c.style.opacity = '1';       
        c.classList.remove('fade-out-game');
        c.style.zIndex = "50";      
        
        setTimeout(() => {
            document.getElementById('final-letter').classList.add('show');
        }, 500);
    }

    // --- –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ (LOOP) ---
    let frame = 0;
    function loop() {
        requestAnimationFrame(loop);
        ctx.clearRect(0, 0, width, height);

        // –£—Ä–æ–≤–µ–Ω—å 1
        if (gameState === 'level1' || gameState === 'transition') {
            frame++;
            if (gameState === 'level1' && frame % CONFIG.spawnRate === 0) items.push(new Item());

            ctx.font = "44px Arial";
            ctx.textAlign = "center";
            ctx.fillText(CONFIG.playerEmoji, playerX, height - 44);

            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.update();
                item.draw();

                const dist = Math.abs(item.x - playerX);
                const distY = Math.abs(item.y - (height - 44));

                if (dist < 36 && distY < 36) {
                    score++;
                    const phrase = compliments[Math.floor(Math.random() * compliments.length)];
                    floatingTexts.push(new FloatingText(item.x, item.y, phrase));
                    updateProgressUI();
                    items.splice(i, 1);
                    if (score >= CONFIG.targetScore) startLevel2();
                } else if (item.y > height) {
                    if (score > 0) score--;
                    const sadPhrase = sadPhrases[Math.floor(Math.random() * sadPhrases.length)];
                    floatingTexts.push(new FloatingText(item.x, height - 50, sadPhrase, "#020079"));
                    updateProgressUI();
                    items.splice(i, 1);
                }
            }
        }

        // –¢–µ–∫—Å—Ç (–¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π, –≤–∫–ª—é—á–∞—è —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –ù–ï–¢)
        for (let i = floatingTexts.length - 1; i >= 0; i--) {
            let ft = floatingTexts[i];
            ft.update();
            ft.draw();
            if (ft.life <= 0) floatingTexts.splice(i, 1);
        }

        // –°–∞–ª—é—Ç (–§–∏–Ω–∞–ª)
        if (gameState === 'win') {
            if (Math.random() < 0.07) createFirework();
            for (let i = fireworks.length - 1; i >= 0; i--) {
                let p = fireworks[i];
                p.update();
                p.draw();
                if (p.life <= 0) fireworks.splice(i, 1);
            }
        }
    }

</script>
</body>
</html>